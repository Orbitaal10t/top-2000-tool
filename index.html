<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPO Radio 2 - Now Playing Tracker</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 28px;
        }

        h2 {
            color: #667eea;
            margin-bottom: 16px;
            font-size: 22px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        /* Now Playing Section */
        .now-playing {
            text-align: center;
            padding: 20px;
        }

        .now-playing .loading {
            color: #999;
            font-style: italic;
        }

        .now-playing .track-info {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .now-playing .cover-image {
            width: 200px;
            height: 200px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            object-fit: cover;
        }

        .now-playing .track-details {
            text-align: center;
        }

        .now-playing .title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .now-playing .artist {
            font-size: 20px;
            color: #666;
        }

        .now-playing .presenter {
            font-size: 14px;
            color: #999;
            margin-top: 8px;
        }

        .now-playing .last-updated {
            font-size: 12px;
            color: #999;
            margin-top: 12px;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #d0d0d0;
        }

        .btn-success {
            background: #1DB954;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #1aa34a;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger:hover:not(:disabled) {
            background: #c82333;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-block {
            width: 100%;
            display: block;
            margin-bottom: 12px;
        }

        /* Storage Choice Screen */
        .storage-choice {
            display: none;
        }

        .storage-choice.active {
            display: block;
        }

        .storage-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 24px 0;
        }

        .storage-option {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .storage-option:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .storage-option.recommended {
            border-color: #1DB954;
            background: #f0fdf4;
        }

        .storage-option h3 {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            background: #1DB954;
            color: #000000;
            padding: 4px 12px;
            border-radius: 500px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .pros-cons {
            font-size: 14px;
            line-height: 1.6;
        }

        .pros-cons div {
            margin: 4px 0;
        }

        .pro {
            color: #059669;
        }

        .con {
            color: #dc2626;
        }

        .recommendation {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 12px;
            margin: 16px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        /* Spotify Connection Status */
        .spotify-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .spotify-status.connected {
            background: #f0fdf4;
            color: #059669;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
        }

        .status-dot.connected {
            background: #1DB954;
        }

        /* Track List */
        .track-list {
            margin-top: 24px;
        }

        .track-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            transition: background 0.2s ease;
        }

        .track-item:hover {
            background: #f9f9f9;
        }

        .track-item:last-child {
            border-bottom: none;
        }

        .track-details {
            flex: 1;
        }

        .track-artist {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .track-title {
            color: #666;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Alert Messages */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .alert-warning {
            background: #fef3c7;
            color: #78350f;
            border: 1px solid #f59e0b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #3b82f6;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .card {
                padding: 16px;
            }

            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            .storage-options {
                grid-template-columns: 1fr;
            }

            .now-playing .cover-image {
                width: 150px;
                height: 150px;
            }

            .now-playing .title {
                font-size: 20px;
            }

            .now-playing .artist {
                font-size: 18px;
            }

            .track-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }

        /* Loading Animation */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Config Section */
        .config-section {
            background: #f9f9f9;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
        }

        .config-section input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 14px;
        }

        .track-count {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 16px;
        }

        /* Spotify-specific styling (volgens Spotify Design Guidelines) */

        /* Admin & Spotify Configuration Cards */
        #adminConfig,
        #userSpotifyLogin {
            background: #191414;
            color: #FFFFFF;
        }

        #adminConfig h2,
        #userSpotifyLogin h2 {
            color: #FFFFFF;
        }

        #adminConfig p,
        #adminConfig ol,
        #userSpotifyLogin p {
            color: #B3B3B3;
        }

        #adminConfig strong {
            color: #FFFFFF;
        }

        #adminConfig a {
            color: #1DB954;
            text-decoration: none;
            font-weight: 700;
        }

        #adminConfig a:hover {
            text-decoration: underline;
        }

        #adminConfig .config-section {
            background: #282828;
        }

        #adminConfig .config-section label {
            color: #FFFFFF;
        }

        #adminConfig .config-section input {
            background: #121212;
            border: 1px solid #535353;
            color: #FFFFFF;
        }

        #adminConfig .config-section input:focus {
            outline: none;
            border-color: #1DB954;
        }

        #adminConfig .config-section input::placeholder {
            color: #6A6A6A;
        }

        #adminConfig code {
            background: #121212;
            color: #1DB954;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        /* Spotify Buttons - volgens Spotify guidelines */
        .btn-spotify {
            background: #1DB954;
            color: #000000;
            border: none;
            border-radius: 500px;
            padding: 16px 48px;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-spotify:hover:not(:disabled) {
            background: #1ED760;
            transform: scale(1.04);
        }

        .btn-spotify:active:not(:disabled) {
            transform: scale(1);
            background: #1AA34A;
        }

        .btn-spotify:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Spotify Connection Status */
        .spotify-status {
            background: #191414;
            color: #B3B3B3;
            border: 1px solid #282828;
        }

        .spotify-status.connected {
            background: rgba(29, 185, 84, 0.1);
            color: #1DB954;
            border: 1px solid #1DB954;
        }

        .spotify-status .status-dot {
            background: #535353;
        }

        .spotify-status .status-dot.connected {
            background: #1DB954;
            box-shadow: 0 0 8px #1DB954;
        }

        /* Spotify Button Overrides */
        #adminConfig .btn-secondary,
        #userSpotifyLogin .btn-secondary,
        .spotify-status .btn-danger {
            background: transparent;
            color: #FFFFFF;
            border: 1px solid #535353;
            border-radius: 500px;
        }

        #adminConfig .btn-secondary:hover:not(:disabled),
        #userSpotifyLogin .btn-secondary:hover:not(:disabled),
        .spotify-status .btn-danger:hover:not(:disabled) {
            border-color: #FFFFFF;
            transform: scale(1.04);
        }

        /* Spotify Storage Option - volgens Spotify brand guidelines */
        .storage-option.recommended {
            border-color: #1DB954;
            background: rgba(29, 185, 84, 0.05);
        }

        .storage-option.recommended:hover {
            background: rgba(29, 185, 84, 0.1);
            border-color: #1DB954;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card">
            <h1><i class="fa-solid fa-music"></i> NPO Radio 2 - Now Playing</h1>
            <p class="subtitle">Track je favoriete nummers voor de Top 2000!</p>

            <!-- Alert Messages -->
            <div id="alert" class="alert"></div>

            <!-- Storage Choice Screen (shown on first visit) -->
            <div id="storageChoice" class="storage-choice">
                <h2>Kies je opslagmethode</h2>
                <p>Waar wil je je nummers bewaren?</p>

                <div class="recommendation">
                    <strong><i class="fa-solid fa-lightbulb"></i> Aanbeveling:</strong> Wij raden Spotify aan voor de beste ervaring en privacy. Je nummers blijven privé, synchroniseren tussen al je apparaten, en je kunt ze direct afspelen!
                </div>

                <div class="storage-options">
                    <div class="storage-option recommended" onclick="chooseStorage('spotify')">
                        <h3>
                            <i class="fa-brands fa-spotify"></i> Spotify
                            <span class="badge">Aanbevolen</span>
                        </h3>
                        <div class="pros-cons">
                            <div class="pro"><i class="fa-solid fa-check"></i> Sync tussen al je apparaten</div>
                            <div class="pro"><i class="fa-solid fa-check"></i> Altijd privé (eigen account)</div>
                            <div class="pro"><i class="fa-solid fa-check"></i> Direct afspelen via Spotify</div>
                            <div class="pro"><i class="fa-solid fa-check"></i> Permanent opgeslagen</div>
                            <div class="con"><i class="fa-solid fa-xmark"></i> Vereist Spotify account (gratis)</div>
                        </div>
                    </div>

                    <div class="storage-option" onclick="chooseStorage('local')">
                        <h3><i class="fa-solid fa-hard-drive"></i> Lokaal</h3>
                        <div class="pros-cons">
                            <div class="pro"><i class="fa-solid fa-check"></i> Geen account nodig</div>
                            <div class="pro"><i class="fa-solid fa-check"></i> Werkt offline</div>
                            <div class="con"><i class="fa-solid fa-xmark"></i> Alleen op dit apparaat + browser</div>
                            <div class="con"><i class="fa-solid fa-xmark"></i> Niet privé bij gedeeld apparaat</div>
                            <div class="con"><i class="fa-solid fa-xmark"></i> Verdwijnt bij cache wissen</div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 24px; padding-top: 24px; border-top: 1px solid #e0e0e0;">
                    <button onclick="showAdminConfig()" class="btn btn-secondary btn-small">
                        <i class="fa-solid fa-shield-halved"></i> Admin configuratie
                    </button>
                </div>
            </div>

            <!-- Main App (hidden until storage is chosen) -->
            <div id="mainApp" style="display: none;">
                <!-- Spotify Connection Status -->
                <div id="spotifyStatus" style="display: none;" class="spotify-status">
                    <div class="status-indicator">
                        <span class="status-dot"></span>
                        <span id="statusText">Niet verbonden</span>
                    </div>
                    <button id="logoutBtn" class="btn btn-danger btn-small" style="display: none;">
                        Uitloggen
                    </button>
                </div>

                <!-- Playlist Selection (only for Spotify users) -->
                <div id="playlistSelector" style="display: none; margin-bottom: 16px; background: #f9f9f9; padding: 16px; border-radius: 8px;">
                    <h3 style="font-size: 16px; margin-bottom: 12px; color: #333;">
                        <i class="fa-solid fa-list-music"></i> Kies je Top 2000 Playlist
                    </h3>
                    <div id="playlistSelectorContent">
                        <div style="text-align: center; color: #999; padding: 20px;">
                            <i class="fa-solid fa-circle-notch fa-spin"></i> Playlists laden...
                        </div>
                    </div>
                </div>

                <!-- Live Listen Button -->
                <div style="text-align: right; margin-bottom: 16px;">
                    <a href="https://www.nporadio2.nl/online-radio-luisteren/gedraaid" target="_blank" rel="noopener noreferrer" class="btn btn-secondary btn-small" style="text-decoration: none; font-size: 13px;">
                        <i class="fa-solid fa-radio"></i> Live luisteren
                    </a>
                </div>

                <!-- Now Playing Section -->
                <div class="now-playing">
                    <div id="nowPlayingContent" class="loading">
                        Bezig met laden...
                    </div>
                </div>

                <!-- Add to List Button -->
                <button id="addToListBtn" class="btn btn-primary btn-block" disabled>
                    <span id="addBtnText">Voeg toe aan mijn stemlijst</span>
                </button>

                <button id="changeStorageBtn" class="btn btn-secondary btn-block">
                    Wijzig opslagmethode
                </button>

                <div style="text-align: center; margin-top: 12px;">
                    <button onclick="showAdminConfig()" class="btn btn-secondary btn-small">
                        <i class="fa-solid fa-shield-halved"></i> Admin
                    </button>
                </div>
            </div>
        </div>

        <!-- Previous Tracks Section -->
        <div id="previousTracksCard" class="card" style="display: none;">
            <h2>Recent Gespeeld</h2>
            <p class="subtitle">Voeg eerdere nummers toe aan je stemlijst</p>
            <div id="previousTracksList"></div>
        </div>

        <!-- Saved Tracks List -->
        <div id="savedTracksCard" class="card" style="display: none;">
            <h2>Mijn Stemlijst</h2>
            <div class="track-count" id="trackCount">0 nummers</div>
            <div id="savedTracksList"></div>
        </div>

        <!-- Admin Configuration (only shown when accessing admin panel) -->
        <div id="adminConfig" class="card" style="display: none;">
            <h2><i class="fa-solid fa-shield-halved"></i> Admin Configuratie</h2>
            <p style="margin-bottom: 16px; font-size: 14px;">
                <strong>Voor beheerders:</strong> Stel de Spotify app in voor al je gebruikers.
            </p>
            <ol style="margin-left: 20px; margin-bottom: 16px; font-size: 14px; line-height: 1.6;">
                <li>Ga naar <a href="https://developer.spotify.com/dashboard" target="_blank">Spotify Developer Dashboard</a></li>
                <li>Maak een nieuwe app aan</li>
                <li>Kopieer de <strong>Client ID</strong></li>
                <li>Voeg deze <strong>Redirect URI</strong> toe: <code id="redirectUriDisplay"></code></li>
                <li>Vul hieronder je Client ID in en sla op</li>
            </ol>
            <div class="config-section">
                <label for="spotifyClientId"><strong>Spotify Client ID:</strong></label>
                <input
                    type="text"
                    id="spotifyClientId"
                    placeholder="Plak hier je Spotify Client ID"
                    value=""
                />
                <button id="saveClientIdBtn" class="btn-spotify btn-block" style="margin-top: 12px;">
                    <i class="fa-solid fa-floppy-disk"></i> Opslaan
                </button>
                <button id="exitAdminBtn" class="btn btn-secondary btn-block" style="margin-top: 8px;">
                    Terug naar hoofdmenu
                </button>
            </div>
        </div>

        <!-- Spotify User Login (for regular users) -->
        <div id="userSpotifyLogin" class="card" style="display: none;">
            <h2><i class="fa-brands fa-spotify"></i> Inloggen met Spotify</h2>
            <p style="margin-bottom: 16px; font-size: 14px; color: #B3B3B3;">
                Log in met je Spotify account om nummers toe te voegen aan je playlist.
            </p>
            <div style="text-align: center; padding: 20px;">
                <button id="spotifyLoginBtn" class="btn-spotify" style="margin-bottom: 16px;">
                    <i class="fa-brands fa-spotify"></i> Inloggen met Spotify
                </button>
                <p style="font-size: 13px; color: #B3B3B3; margin-top: 16px;">
                    <i class="fa-solid fa-info-circle"></i> Je hebt een gratis Spotify account nodig
                </p>
            </div>
            <button id="backToStorageBtn" class="btn btn-secondary btn-block">
                Terug naar opslagkeuze
            </button>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const NPO_API_URL = 'https://www.nporadio2.nl/api/miniplayer/info?channel=npo-radio-2';
        const SPOTIFY_AUTH_URL = 'https://accounts.spotify.com/authorize';
        const SPOTIFY_TOKEN_URL = 'https://accounts.spotify.com/api/token';
        const SPOTIFY_API_URL = 'https://api.spotify.com/v1';
        const POLL_INTERVAL = 15000; // 15 seconds
        const SPOTIFY_SCOPES = 'playlist-modify-public playlist-modify-private playlist-read-private';

        // Get redirect URI dynamically
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        // ============================================
        // STATE
        // ============================================
        let currentTrack = null;
        let previousTracks = [];
        let storageMethod = null;
        let spotifyAccessToken = null;
        let spotifyRefreshToken = null;
        let spotifyTokenExpiry = null;
        let pollTimer = null;
        let isAddingTrack = false;
        let selectedPlaylistId = null;
        let userPlaylists = [];

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.innerHTML = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function saveToLocalStorage(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        function getFromLocalStorage(key) {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
        }

        function updateTrackCount() {
            const tracks = getFromLocalStorage('top2000lijst') || [];
            const countEl = document.getElementById('trackCount');
            const count = tracks.length;
            countEl.textContent = `${count} ${count === 1 ? 'nummer' : 'nummers'}`;
        }

        // ============================================
        // SPOTIFY PKCE FUNCTIONS
        // ============================================
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], '');
        }

        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        function base64urlencode(a) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function generateCodeChallenge(codeVerifier) {
            const hashed = await sha256(codeVerifier);
            return base64urlencode(hashed);
        }

        // ============================================
        // SPOTIFY AUTHENTICATION
        // ============================================
        async function initiateSpotifyLogin() {
            const clientId = getFromLocalStorage('spotifyClientId');

            if (!clientId) {
                showAlert('Spotify is nog niet geconfigureerd. Vraag de beheerder om de app in te stellen.', 'warning');
                return;
            }

            const codeVerifier = generateRandomString(64);
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            // Store code verifier for later use
            saveToLocalStorage('spotifyCodeVerifier', codeVerifier);

            const params = new URLSearchParams({
                client_id: clientId,
                response_type: 'code',
                redirect_uri: REDIRECT_URI,
                scope: SPOTIFY_SCOPES,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });

            window.location.href = `${SPOTIFY_AUTH_URL}?${params.toString()}`;
        }

        async function loginWithSpotify() {
            // Set storage method
            storageMethod = 'spotify';
            saveToLocalStorage('storageMethod', 'spotify');

            // Initiate Spotify login
            await initiateSpotifyLogin();
        }

        async function handleSpotifyCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');

            if (error) {
                showAlert(`Spotify authenticatie mislukt: ${error}`, 'error');
                return;
            }

            if (code) {
                const codeVerifier = getFromLocalStorage('spotifyCodeVerifier');
                const clientId = getFromLocalStorage('spotifyClientId');

                if (!codeVerifier || !clientId) {
                    showAlert('Authenticatie fout: verifier of client ID ontbreekt', 'error');
                    return;
                }

                try {
                    const response = await fetch(SPOTIFY_TOKEN_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            client_id: clientId,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: REDIRECT_URI,
                            code_verifier: codeVerifier
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Token exchange failed');
                    }

                    const data = await response.json();

                    // Store tokens
                    spotifyAccessToken = data.access_token;
                    spotifyRefreshToken = data.refresh_token;
                    spotifyTokenExpiry = Date.now() + (data.expires_in * 1000);

                    saveToLocalStorage('spotifyAccessToken', spotifyAccessToken);
                    saveToLocalStorage('spotifyRefreshToken', spotifyRefreshToken);
                    saveToLocalStorage('spotifyTokenExpiry', spotifyTokenExpiry);

                    // Clean up URL and code verifier
                    localStorage.removeItem('spotifyCodeVerifier');
                    window.history.replaceState({}, document.title, window.location.pathname);

                    // Set storage method if not already set
                    if (!storageMethod) {
                        storageMethod = 'spotify';
                        saveToLocalStorage('storageMethod', 'spotify');
                    }

                    showAlert('<i class="fa-solid fa-circle-check"></i> Succesvol verbonden met Spotify!', 'success');

                    // Hide login screen and show main app
                    document.getElementById('userSpotifyLogin').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';

                    await updateSpotifyStatus();

                    // Start the app
                    fetchNowPlaying();
                    startPolling();
                    renderTrackList();
                    updateTrackCount();

                } catch (error) {
                    console.error('Token exchange error:', error);
                    showAlert('Fout bij verbinden met Spotify. Probeer opnieuw.', 'error');
                }
            }
        }

        async function refreshSpotifyToken() {
            const clientId = getFromLocalStorage('spotifyClientId');
            const refreshToken = getFromLocalStorage('spotifyRefreshToken');

            if (!refreshToken || !clientId) {
                return false;
            }

            try {
                const response = await fetch(SPOTIFY_TOKEN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        client_id: clientId,
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken
                    })
                });

                if (!response.ok) {
                    throw new Error('Token refresh failed');
                }

                const data = await response.json();

                spotifyAccessToken = data.access_token;
                spotifyTokenExpiry = Date.now() + (data.expires_in * 1000);

                // Update refresh token if provided
                if (data.refresh_token) {
                    spotifyRefreshToken = data.refresh_token;
                    saveToLocalStorage('spotifyRefreshToken', spotifyRefreshToken);
                }

                saveToLocalStorage('spotifyAccessToken', spotifyAccessToken);
                saveToLocalStorage('spotifyTokenExpiry', spotifyTokenExpiry);

                return true;
            } catch (error) {
                console.error('Token refresh error:', error);
                return false;
            }
        }

        async function ensureValidToken() {
            // Check if token exists
            if (!spotifyAccessToken) {
                return false;
            }

            // Check if token is expired or about to expire (5 minute buffer)
            if (spotifyTokenExpiry && (Date.now() + 300000) >= spotifyTokenExpiry) {
                return await refreshSpotifyToken();
            }

            return true;
        }

        async function updateSpotifyStatus() {
            const statusDiv = document.getElementById('spotifyStatus');
            const statusText = document.getElementById('statusText');
            const statusDot = statusDiv.querySelector('.status-dot');
            const logoutBtn = document.getElementById('logoutBtn');
            const playlistSelector = document.getElementById('playlistSelector');

            if (storageMethod === 'spotify') {
                statusDiv.style.display = 'flex';

                if (spotifyAccessToken) {
                    statusDiv.classList.add('connected');
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Verbonden met Spotify';
                    logoutBtn.style.display = 'block';

                    // Show playlist selector
                    playlistSelector.style.display = 'block';
                    await loadAndDisplayPlaylists();
                } else {
                    statusDiv.classList.remove('connected');
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Niet verbonden - klik hieronder om in te loggen';
                    logoutBtn.style.display = 'none';
                    playlistSelector.style.display = 'none';
                }
            } else {
                statusDiv.style.display = 'none';
                playlistSelector.style.display = 'none';
            }
        }

        function logoutSpotify() {
            if (confirm('Weet je zeker dat je wilt uitloggen van Spotify?')) {
                spotifyAccessToken = null;
                spotifyRefreshToken = null;
                spotifyTokenExpiry = null;
                selectedPlaylistId = null;

                localStorage.removeItem('spotifyAccessToken');
                localStorage.removeItem('spotifyRefreshToken');
                localStorage.removeItem('spotifyTokenExpiry');
                localStorage.removeItem('selectedPlaylistId');
                localStorage.removeItem('storageMethod');

                // Go back to storage choice
                storageMethod = null;
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('storageChoice').classList.add('active');

                showAlert('Uitgelogd van Spotify', 'info');
            }
        }

        // ============================================
        // NPO RADIO 2 API
        // ============================================
        async function fetchNowPlaying() {
            try {
                const response = await fetch(NPO_API_URL);

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();

                // Parse the response - miniplayer API format
                // Get all tracks from radioTrackPlays
                const allTracks = data?.data?.radioTrackPlays?.data || [];
                const currentBroadcast = data?.data?.radioBroadcasts?.data?.[0];

                if (allTracks.length === 0) {
                    throw new Error('No tracks found');
                }

                // Get current playing track (first one)
                const currentPlay = allTracks[0];

                if (currentPlay?.artist && currentPlay?.song) {
                    currentTrack = {
                        artist: currentPlay.artist,
                        title: currentPlay.song,
                        coverUrl: currentPlay.radioTracks?.coverUrl || null,
                        presenters: currentBroadcast?.radioPresenters?.map(p => p.name) || [],
                        timestamp: new Date().toISOString()
                    };

                    displayNowPlaying(currentTrack);
                    document.getElementById('addToListBtn').disabled = false;
                } else {
                    throw new Error('Invalid data format');
                }

                // Get previous tracks (skip first one which is current)
                previousTracks = allTracks.slice(1).map(track => ({
                    artist: track.artist,
                    title: track.song,
                    from: track.from,
                    until: track.until,
                    coverUrl: track.radioTracks?.coverUrl || null
                }));

                // Display previous tracks
                displayPreviousTracks();

            } catch (error) {
                console.error('Error fetching now playing:', error);
                document.getElementById('nowPlayingContent').innerHTML = `
                    <div class="loading"><i class="fa-solid fa-triangle-exclamation"></i> Kon niet verbinden met NPO Radio 2 API</div>
                `;
                document.getElementById('addToListBtn').disabled = true;
            }
        }

        function displayNowPlaying(track) {
            const container = document.getElementById('nowPlayingContent');
            const now = new Date().toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });

            const coverHtml = track.coverUrl
                ? `<img src="${escapeHtml(track.coverUrl)}" alt="Album cover" class="cover-image" onerror="this.style.display='none'">`
                : '';

            const presenterHtml = track.presenters && track.presenters.length > 0
                ? `<div class="presenter"><i class="fa-solid fa-microphone"></i> ${escapeHtml(track.presenters.join(', '))}</div>`
                : '';

            container.innerHTML = `
                <div class="track-info">
                    ${coverHtml}
                    <div class="track-details">
                        <div class="artist">${escapeHtml(track.artist)}</div>
                        <div class="title">${escapeHtml(track.title)}</div>
                        ${presenterHtml}
                        <div class="last-updated">Bijgewerkt om ${now}</div>
                    </div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function displayPreviousTracks() {
            const container = document.getElementById('previousTracksList');
            const card = document.getElementById('previousTracksCard');

            if (previousTracks.length === 0) {
                card.style.display = 'none';
                return;
            }

            card.style.display = 'block';

            const html = previousTracks.map((track, index) => {
                // Format time
                const fromTime = new Date(track.from).toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });
                const untilTime = new Date(track.until).toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="track-item">
                        <div class="track-details">
                            <div class="track-title">${escapeHtml(track.title)}</div>
                            <div class="track-artist">${escapeHtml(track.artist)}</div>
                            
                            <div style="font-size: 12px; color: #6A6A6A; margin-top: 4px;">${fromTime} - ${untilTime}</div>
                        </div>
                        <button class="btn btn-primary btn-small" onclick="addPreviousTrackToList(${index})">
                            Voeg toe
                        </button>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        // ============================================
        // SPOTIFY API
        // ============================================
        async function searchSpotifyTrack(artist, title) {
            const isValid = await ensureValidToken();

            if (!isValid) {
                throw new Error('No valid Spotify token');
            }

            const query = `artist:${artist} track:${title}`;
            const params = new URLSearchParams({
                q: query,
                type: 'track',
                limit: 1
            });

            const response = await fetch(`${SPOTIFY_API_URL}/search?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Spotify search failed');
            }

            const data = await response.json();

            if (data.tracks && data.tracks.items && data.tracks.items.length > 0) {
                return data.tracks.items[0];
            }

            return null;
        }

        async function getUserPlaylists() {
            const isValid = await ensureValidToken();

            if (!isValid) {
                throw new Error('No valid Spotify token');
            }

            const response = await fetch(`${SPOTIFY_API_URL}/me/playlists?limit=50`, {
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch playlists');
            }

            const data = await response.json();
            return data.items || [];
        }

        async function createPlaylist(name) {
            const isValid = await ensureValidToken();

            if (!isValid) {
                throw new Error('No valid Spotify token');
            }

            // First get user ID
            const userResponse = await fetch(`${SPOTIFY_API_URL}/me`, {
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`
                }
            });

            if (!userResponse.ok) {
                throw new Error('Failed to get user info');
            }

            const userData = await userResponse.json();
            const userId = userData.id;

            // Create playlist
            const response = await fetch(`${SPOTIFY_API_URL}/users/${userId}/playlists`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: name,
                    description: 'Mijn Top 2000 stemlijst - gemaakt via NPO Radio 2 tracker',
                    public: false
                })
            });

            if (!response.ok) {
                throw new Error('Failed to create playlist');
            }

            return await response.json();
        }

        async function addToSpotifyPlaylist(playlistId, trackUri) {
            const isValid = await ensureValidToken();

            if (!isValid) {
                throw new Error('No valid Spotify token');
            }

            const response = await fetch(`${SPOTIFY_API_URL}/playlists/${playlistId}/tracks`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    uris: [trackUri]
                })
            });

            if (!response.ok) {
                throw new Error('Failed to add to playlist');
            }

            return true;
        }

        async function getPlaylistTracks(playlistId) {
            const isValid = await ensureValidToken();

            if (!isValid) {
                throw new Error('No valid Spotify token');
            }

            let allTracks = [];
            let url = `${SPOTIFY_API_URL}/playlists/${playlistId}/tracks?limit=100`;

            while (url) {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${spotifyAccessToken}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch playlist tracks');
                }

                const data = await response.json();
                allTracks = allTracks.concat(data.items);
                url = data.next;
            }

            return allTracks;
        }

        // ============================================
        // TRACK MANAGEMENT
        // ============================================
        async function addTrackToList() {
            if (!currentTrack || isAddingTrack) {
                return;
            }

            isAddingTrack = true;
            const addBtn = document.getElementById('addToListBtn');
            const btnText = document.getElementById('addBtnText');
            const originalText = btnText.textContent;

            addBtn.disabled = true;
            btnText.innerHTML = '<span class="spinner"></span> Bezig met toevoegen...';

            try {
                await addTrack(currentTrack);
            } catch (error) {
                console.error('Error adding track:', error);
                showAlert('<i class="fa-solid fa-triangle-exclamation"></i> Fout bij toevoegen. Probeer opnieuw.', 'error');
            } finally {
                isAddingTrack = false;
                addBtn.disabled = false;
                btnText.textContent = originalText;
            }
        }

        async function addPreviousTrackToList(index) {
            if (index < 0 || index >= previousTracks.length) {
                return;
            }

            const track = previousTracks[index];
            const trackObj = {
                artist: track.artist,
                title: track.title,
                timestamp: track.from,
                coverUrl: track.coverUrl
            };

            try {
                await addTrack(trackObj);
            } catch (error) {
                console.error('Error adding previous track:', error);
                showAlert('<i class="fa-solid fa-triangle-exclamation"></i> Fout bij toevoegen. Probeer opnieuw.', 'error');
            }
        }

        async function addTrack(track) {
            // Handle based on storage method
            if (storageMethod === 'spotify') {
                if (!spotifyAccessToken) {
                    showAlert('Je bent niet verbonden met Spotify. Log eerst in!', 'warning');
                    await initiateSpotifyLogin();
                    return;
                }

                if (!selectedPlaylistId) {
                    showAlert('Kies eerst een playlist!', 'warning');
                    return;
                }

                // Search for track on Spotify
                const spotifyTrack = await searchSpotifyTrack(track.artist, track.title);

                if (!spotifyTrack) {
                    showAlert('Nummer niet gevonden op Spotify.', 'error');
                    return;
                }

                // Add to Spotify playlist
                await addToSpotifyPlaylist(selectedPlaylistId, spotifyTrack.uri);
                showAlert('<i class="fa-solid fa-circle-check"></i> Nummer toegevoegd aan je Spotify playlist!', 'success');

                // Refresh the track list from Spotify
                await syncPlaylistToTrackList();
            } else {
                // Local storage only
                const localTracks = getFromLocalStorage('top2000lijst') || [];

                // Check for duplicates
                const isDuplicate = localTracks.some(t =>
                    t.artist.toLowerCase() === track.artist.toLowerCase() &&
                    t.title.toLowerCase() === track.title.toLowerCase()
                );

                if (isDuplicate) {
                    showAlert('Dit nummer staat al in je lijst!', 'warning');
                    return;
                }

                localTracks.push(track);
                saveToLocalStorage('top2000lijst', localTracks);
                showAlert('<i class="fa-solid fa-circle-check"></i> Nummer toegevoegd aan je lokale lijst!', 'success');

                renderTrackList();
                updateTrackCount();
            }
        }

        async function removeTrack(index) {
            if (!confirm('Weet je zeker dat je dit nummer wilt verwijderen?')) {
                return;
            }

            if (storageMethod === 'spotify' && selectedPlaylistId) {
                // Get playlist tracks to find the track to remove
                const playlistTracks = await getPlaylistTracks(selectedPlaylistId);

                if (index >= 0 && index < playlistTracks.length) {
                    const trackToRemove = playlistTracks[index];
                    const trackUri = trackToRemove.track.uri;

                    // Remove from Spotify playlist
                    const isValid = await ensureValidToken();
                    if (isValid) {
                        await fetch(`${SPOTIFY_API_URL}/playlists/${selectedPlaylistId}/tracks`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${spotifyAccessToken}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                tracks: [{ uri: trackUri }]
                            })
                        });

                        showAlert('Nummer verwijderd uit playlist', 'info');
                        await syncPlaylistToTrackList();
                    }
                }
            } else {
                // Local storage
                const tracks = getFromLocalStorage('top2000lijst') || [];
                tracks.splice(index, 1);
                saveToLocalStorage('top2000lijst', tracks);
                renderTrackList();
                updateTrackCount();
                showAlert('Nummer verwijderd', 'info');
            }
        }

        async function syncPlaylistToTrackList() {
            if (!selectedPlaylistId) {
                return;
            }

            try {
                const playlistTracks = await getPlaylistTracks(selectedPlaylistId);

                // Convert to our format
                const tracks = playlistTracks.map(item => ({
                    artist: item.track.artists.map(a => a.name).join(', '),
                    title: item.track.name,
                    spotifyUri: item.track.uri,
                    timestamp: item.added_at
                }));

                // Save to localStorage for consistency
                saveToLocalStorage('top2000lijst', tracks);
                renderTrackList();
                updateTrackCount();
            } catch (error) {
                console.error('Error syncing playlist:', error);
            }
        }

        async function loadAndDisplayPlaylists() {
            const container = document.getElementById('playlistSelectorContent');

            try {
                userPlaylists = await getUserPlaylists();

                if (userPlaylists.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <p style="color: #666; margin-bottom: 12px;">Je hebt nog geen playlists.</p>
                            <button class="btn-spotify" onclick="createNewPlaylist()" style="padding: 12px 24px; font-size: 14px;">
                                <i class="fa-solid fa-plus"></i> Maak nieuwe playlist
                            </button>
                        </div>
                    `;
                    return;
                }

                // Create dropdown and new playlist button
                let html = `
                    <select id="playlistDropdown" class="form-select" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; margin-bottom: 12px;">
                        <option value="">-- Kies een playlist --</option>
                `;

                userPlaylists.forEach(playlist => {
                    const selected = playlist.id === selectedPlaylistId ? 'selected' : '';
                    html += `<option value="${playlist.id}" ${selected}>${escapeHtml(playlist.name)} (${playlist.tracks.total} nummers)</option>`;
                });

                html += `
                    </select>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" onclick="selectPlaylist()" style="flex: 1;">
                            <i class="fa-solid fa-check"></i> Selecteer Playlist
                        </button>
                        <button class="btn btn-secondary" onclick="createNewPlaylist()">
                            <i class="fa-solid fa-plus"></i> Nieuwe
                        </button>
                    </div>
                `;

                if (selectedPlaylistId) {
                    const selectedPlaylist = userPlaylists.find(p => p.id === selectedPlaylistId);
                    if (selectedPlaylist) {
                        html += `
                            <div style="margin-top: 12px; padding: 12px; background: #e8f5e9; border-radius: 4px; font-size: 14px; color: #2e7d32;">
                                <i class="fa-solid fa-circle-check"></i> Geselecteerd: <strong>${escapeHtml(selectedPlaylist.name)}</strong>
                            </div>
                        `;
                    }
                }

                container.innerHTML = html;

            } catch (error) {
                console.error('Error loading playlists:', error);
                container.innerHTML = `
                    <div style="text-align: center; color: #dc2626; padding: 20px;">
                        <i class="fa-solid fa-triangle-exclamation"></i> Fout bij laden playlists
                    </div>
                `;
            }
        }

        async function selectPlaylist() {
            const dropdown = document.getElementById('playlistDropdown');
            const playlistId = dropdown.value;

            if (!playlistId) {
                showAlert('Kies een playlist uit de lijst', 'warning');
                return;
            }

            selectedPlaylistId = playlistId;
            saveToLocalStorage('selectedPlaylistId', playlistId);

            showAlert('<i class="fa-solid fa-circle-check"></i> Playlist geselecteerd!', 'success');

            // Sync playlist to track list
            await syncPlaylistToTrackList();

            // Refresh display
            await loadAndDisplayPlaylists();
        }

        async function createNewPlaylist() {
            const name = prompt('Geef je nieuwe playlist een naam:', 'Mijn Top 2000 Stemlijst');

            if (!name || name.trim() === '') {
                return;
            }

            try {
                const newPlaylist = await createPlaylist(name.trim());
                selectedPlaylistId = newPlaylist.id;
                saveToLocalStorage('selectedPlaylistId', selectedPlaylistId);

                showAlert('<i class="fa-solid fa-circle-check"></i> Playlist aangemaakt en geselecteerd!', 'success');

                // Refresh playlist list
                await loadAndDisplayPlaylists();

                // Sync (will be empty but sets up structure)
                await syncPlaylistToTrackList();

            } catch (error) {
                console.error('Error creating playlist:', error);
                showAlert('Fout bij aanmaken playlist. Probeer opnieuw.', 'error');
            }
        }

        function renderTrackList() {
            const tracks = getFromLocalStorage('top2000lijst') || [];
            const container = document.getElementById('savedTracksList');
            const card = document.getElementById('savedTracksCard');

            if (tracks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="fa-solid fa-music"></i></div>
                        <p>Nog geen nummers toegevoegd</p>
                        <p style="font-size: 14px; margin-top: 8px;">Voeg nummers toe terwijl je luistert!</p>
                    </div>
                `;
                card.style.display = 'block';
                return;
            }

            card.style.display = 'block';

            const html = tracks.map((track, index) => `
                <div class="track-item">
                    <div class="track-details">
                        <div class="track-artist">${escapeHtml(track.artist)}</div>
                        <div class="track-title">${escapeHtml(track.title)}</div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeTrack(${index})">
                        Verwijder
                    </button>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // ============================================
        // ADMIN CONFIGURATION
        // ============================================
        function showAdminConfig() {
            // Hide all screens
            document.getElementById('storageChoice').classList.remove('active');
            document.getElementById('mainApp').style.display = 'none';
            document.getElementById('userSpotifyLogin').style.display = 'none';

            // Show admin config
            document.getElementById('adminConfig').style.display = 'block';
        }

        function saveClientId() {
            const clientId = document.getElementById('spotifyClientId').value.trim();

            if (!clientId) {
                showAlert('Vul een Client ID in', 'warning');
                return;
            }

            saveToLocalStorage('spotifyClientId', clientId);
            showAlert('<i class="fa-solid fa-circle-check"></i> Client ID opgeslagen! Gebruikers kunnen nu inloggen.', 'success');
        }

        function exitAdminConfig() {
            document.getElementById('adminConfig').style.display = 'none';

            // Go back to storage choice
            if (!storageMethod) {
                document.getElementById('storageChoice').classList.add('active');
            } else {
                document.getElementById('mainApp').style.display = 'block';
            }
        }

        // ============================================
        // STORAGE CHOICE
        // ============================================
        async function chooseStorage(method) {
            if (method === 'spotify') {
                // Check if Client ID is configured
                const clientId = getFromLocalStorage('spotifyClientId');

                if (!clientId) {
                    showAlert('Spotify is nog niet geconfigureerd. Vraag de beheerder om de app in te stellen.', 'warning');
                    return;
                }

                // Hide storage choice
                document.getElementById('storageChoice').classList.remove('active');

                // Check if already logged in
                if (spotifyAccessToken) {
                    // Already logged in, go to main app
                    storageMethod = 'spotify';
                    saveToLocalStorage('storageMethod', method);
                    document.getElementById('mainApp').style.display = 'block';
                    await updateSpotifyStatus();
                    fetchNowPlaying();
                    startPolling();
                    renderTrackList();
                    updateTrackCount();
                } else {
                    // Show login screen
                    document.getElementById('userSpotifyLogin').style.display = 'block';
                }
            } else {
                // Local storage
                storageMethod = method;
                saveToLocalStorage('storageMethod', method);

                document.getElementById('storageChoice').classList.remove('active');
                document.getElementById('mainApp').style.display = 'block';
                showAlert('Lokale opslag actief. Let op: lijst is alleen zichtbaar op dit apparaat.', 'info');

                // Start fetching now playing
                fetchNowPlaying();
                startPolling();
                renderTrackList();
                updateTrackCount();
            }
        }

        function backToStorageChoice() {
            document.getElementById('userSpotifyLogin').style.display = 'none';
            document.getElementById('storageChoice').classList.add('active');
        }

        function changeStorage() {
            if (confirm('Weet je zeker dat je de opslagmethode wilt wijzigen? Je huidige lijst blijft bewaard.')) {
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('storageChoice').classList.add('active');
                stopPolling();
            }
        }

        // ============================================
        // POLLING
        // ============================================
        function startPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
            }
            pollTimer = setInterval(fetchNowPlaying, POLL_INTERVAL);
        }

        function stopPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        async function init() {
            // Display redirect URI for user
            document.getElementById('redirectUriDisplay').textContent = REDIRECT_URI;

            // Load saved data
            storageMethod = getFromLocalStorage('storageMethod');
            spotifyAccessToken = getFromLocalStorage('spotifyAccessToken');
            spotifyRefreshToken = getFromLocalStorage('spotifyRefreshToken');
            spotifyTokenExpiry = getFromLocalStorage('spotifyTokenExpiry');
            selectedPlaylistId = getFromLocalStorage('selectedPlaylistId');

            // Load saved Spotify Client ID
            const savedClientId = getFromLocalStorage('spotifyClientId');
            if (savedClientId) {
                document.getElementById('spotifyClientId').value = savedClientId;
            }

            // Check for OAuth callback
            if (window.location.search.includes('code=')) {
                await handleSpotifyCallback();
            }

            // Show appropriate screen
            if (storageMethod) {
                if (storageMethod === 'spotify' && !spotifyAccessToken) {
                    // Spotify selected but not logged in - show login screen
                    document.getElementById('userSpotifyLogin').style.display = 'block';
                } else {
                    // Show main app
                    document.getElementById('mainApp').style.display = 'block';

                    if (storageMethod === 'spotify') {
                        await updateSpotifyStatus();

                        // If we have a selected playlist, sync it
                        if (selectedPlaylistId && spotifyAccessToken) {
                            await syncPlaylistToTrackList();
                        }
                    }

                    fetchNowPlaying();
                    startPolling();
                    renderTrackList();
                    updateTrackCount();
                }
            } else {
                document.getElementById('storageChoice').classList.add('active');
            }

            // Event listeners
            document.getElementById('addToListBtn').addEventListener('click', addTrackToList);
            document.getElementById('changeStorageBtn').addEventListener('click', changeStorage);
            document.getElementById('logoutBtn').addEventListener('click', logoutSpotify);

            // Admin config listeners
            document.getElementById('saveClientIdBtn').addEventListener('click', saveClientId);
            document.getElementById('exitAdminBtn').addEventListener('click', exitAdminConfig);

            // User login listeners
            document.getElementById('spotifyLoginBtn').addEventListener('click', loginWithSpotify);
            document.getElementById('backToStorageBtn').addEventListener('click', backToStorageChoice);

            // Make functions global
            window.removeTrack = removeTrack;
            window.addPreviousTrackToList = addPreviousTrackToList;
            window.selectPlaylist = selectPlaylist;
            window.createNewPlaylist = createNewPlaylist;
            window.chooseStorage = chooseStorage;
            window.showAdminConfig = showAdminConfig;
        }

        // Start the app
        init();
    </script>
</body>
</html>
