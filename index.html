<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPO Radio 2 - Now Playing Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Circular', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            background: #121212;
            min-height: 100vh;
            padding: 24px;
            color: #FFFFFF;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: #181818;
            border-radius: 8px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            transition: background 0.3s ease;
        }

        .card:hover {
            background: #202020;
        }

        h1 {
            color: #FFFFFF;
            margin-bottom: 8px;
            font-size: 48px;
            font-weight: 700;
            letter-spacing: -0.04em;
        }

        h2 {
            color: #FFFFFF;
            margin-bottom: 24px;
            font-size: 32px;
            font-weight: 700;
            letter-spacing: -0.04em;
        }

        .subtitle {
            color: #B3B3B3;
            margin-bottom: 24px;
            font-size: 16px;
            line-height: 1.6;
        }

        /* Now Playing Section */
        .now-playing {
            text-align: center;
            padding: 32px 24px;
        }

        .now-playing .loading {
            color: #B3B3B3;
            font-style: italic;
        }

        .now-playing .track-info {
            margin: 32px 0;
        }

        .now-playing .artist {
            font-size: 36px;
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 12px;
            letter-spacing: -0.04em;
        }

        .now-playing .title {
            font-size: 24px;
            color: #B3B3B3;
            font-weight: 400;
        }

        .now-playing .last-updated {
            font-size: 14px;
            color: #6A6A6A;
            margin-top: 16px;
        }

        /* Buttons */
        .btn {
            padding: 16px 48px;
            border: none;
            border-radius: 500px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
            text-decoration: none;
            text-align: center;
            text-transform: none;
            letter-spacing: 0.1em;
        }

        .btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #1DB954;
            color: #000000;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1ED760;
            transform: scale(1.04);
        }

        .btn-primary:active:not(:disabled) {
            transform: scale(1);
            background: #1AA34A;
        }

        .btn-secondary {
            background: transparent;
            color: #B3B3B3;
            border: 1px solid #535353;
        }

        .btn-secondary:hover:not(:disabled) {
            border-color: #FFFFFF;
            color: #FFFFFF;
            transform: scale(1.04);
        }

        .btn-success {
            background: #1DB954;
            color: #000000;
        }

        .btn-success:hover:not(:disabled) {
            background: #1ED760;
            transform: scale(1.04);
        }

        .btn-danger {
            background: transparent;
            color: #FFFFFF;
            padding: 8px 16px;
            font-size: 14px;
            border: 1px solid #535353;
        }

        .btn-danger:hover:not(:disabled) {
            border-color: #FFFFFF;
            transform: scale(1.04);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 700;
        }

        .btn-block {
            width: 100%;
            display: block;
            margin-bottom: 16px;
        }

        /* Storage Choice Screen */
        .storage-choice {
            display: none;
        }

        .storage-choice.active {
            display: block;
        }

        .storage-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 32px 0;
        }

        .storage-option {
            border: 1px solid #282828;
            border-radius: 8px;
            padding: 24px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #181818;
        }

        .storage-option:hover {
            background: #282828;
            transform: scale(1.02);
        }

        .storage-option.recommended {
            border-color: #1DB954;
            background: rgba(29, 185, 84, 0.1);
        }

        .storage-option.recommended:hover {
            background: rgba(29, 185, 84, 0.15);
        }

        .storage-option h3 {
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #FFFFFF;
            font-size: 20px;
            font-weight: 700;
        }

        .badge {
            background: #1DB954;
            color: #000000;
            padding: 4px 12px;
            border-radius: 500px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .pros-cons {
            font-size: 14px;
            line-height: 1.8;
        }

        .pros-cons div {
            margin: 8px 0;
        }

        .pro {
            color: #1DB954;
        }

        .con {
            color: #B3B3B3;
        }

        .recommendation {
            background: rgba(29, 185, 84, 0.1);
            border-left: 4px solid #1DB954;
            padding: 16px;
            margin: 24px 0;
            border-radius: 4px;
            font-size: 14px;
            color: #FFFFFF;
            line-height: 1.6;
        }

        .recommendation strong {
            color: #1DB954;
        }

        /* Spotify Connection Status */
        .spotify-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: #282828;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .spotify-status.connected {
            background: rgba(29, 185, 84, 0.1);
            color: #1DB954;
            border: 1px solid #1DB954;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #535353;
        }

        .status-dot.connected {
            background: #1DB954;
            box-shadow: 0 0 8px #1DB954;
        }

        /* Track List */
        .track-list {
            margin-top: 24px;
        }

        .track-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-radius: 4px;
            transition: background 0.2s ease;
            margin-bottom: 8px;
        }

        .track-item:hover {
            background: #282828;
        }

        .track-details {
            flex: 1;
        }

        .track-artist {
            font-weight: 700;
            color: #FFFFFF;
            margin-bottom: 4px;
            font-size: 16px;
        }

        .track-title {
            color: #B3B3B3;
            font-size: 14px;
        }

        .empty-state {
            text-align: center;
            padding: 64px 24px;
            color: #6A6A6A;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 24px;
            opacity: 0.5;
        }

        /* Alert Messages */
        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 14px;
            display: none;
            border-left: 4px solid;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: rgba(29, 185, 84, 0.1);
            color: #1DB954;
            border-color: #1DB954;
        }

        .alert-error {
            background: rgba(255, 85, 85, 0.1);
            color: #FF5555;
            border-color: #FF5555;
        }

        .alert-warning {
            background: rgba(255, 187, 51, 0.1);
            color: #FFBB33;
            border-color: #FFBB33;
        }

        .alert-info {
            background: rgba(29, 185, 84, 0.1);
            color: #1DB954;
            border-color: #1DB954;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 16px;
            }

            .card {
                padding: 24px;
            }

            h1 {
                font-size: 32px;
            }

            h2 {
                font-size: 24px;
            }

            .storage-options {
                grid-template-columns: 1fr;
            }

            .now-playing .artist {
                font-size: 28px;
            }

            .now-playing .title {
                font-size: 18px;
            }

            .track-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .btn {
                padding: 14px 32px;
                font-size: 14px;
            }
        }

        /* Loading Animation */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(29, 185, 84, 0.3);
            border-radius: 50%;
            border-top-color: #1DB954;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Config Section */
        .config-section {
            background: #282828;
            padding: 24px;
            border-radius: 8px;
            margin-top: 24px;
            font-size: 14px;
        }

        .config-section label {
            color: #FFFFFF;
            font-weight: 700;
            margin-bottom: 8px;
            display: block;
        }

        .config-section input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #535353;
            border-radius: 4px;
            margin-top: 8px;
            font-size: 14px;
            background: #121212;
            color: #FFFFFF;
            transition: border-color 0.2s ease;
        }

        .config-section input:focus {
            outline: none;
            border-color: #1DB954;
        }

        .config-section input::placeholder {
            color: #6A6A6A;
        }

        .config-section ol {
            color: #B3B3B3;
        }

        .config-section a {
            color: #1DB954;
            text-decoration: none;
            font-weight: 700;
        }

        .config-section a:hover {
            color: #1ED760;
            text-decoration: underline;
        }

        .config-section code {
            background: #121212;
            color: #1DB954;
            padding: 4px 8px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }

        .track-count {
            font-weight: 700;
            color: #1DB954;
            margin-bottom: 24px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="card">
            <h1>üéµ NPO Radio 2 - Now Playing</h1>
            <p class="subtitle">Track je favoriete nummers voor de Top 2000!</p>

            <!-- Alert Messages -->
            <div id="alert" class="alert"></div>

            <!-- Storage Choice Screen (shown on first visit) -->
            <div id="storageChoice" class="storage-choice">
                <h2>Kies je opslagmethode</h2>
                <p class="subtitle">Waar wil je je nummers bewaren?</p>

                <div class="recommendation">
                    <strong>üí° Aanbeveling:</strong> Wij raden Spotify aan voor de beste ervaring en privacy. Je nummers blijven priv√©, synchroniseren tussen al je apparaten, en je kunt ze direct afspelen!
                </div>

                <div class="storage-options">
                    <div class="storage-option recommended" onclick="chooseStorage('spotify')">
                        <h3>
                            üéß Spotify
                            <span class="badge">Aanbevolen</span>
                        </h3>
                        <div class="pros-cons">
                            <div class="pro">‚úÖ Sync tussen al je apparaten</div>
                            <div class="pro">‚úÖ Altijd priv√© (eigen account)</div>
                            <div class="pro">‚úÖ Direct afspelen via Spotify</div>
                            <div class="pro">‚úÖ Permanent opgeslagen</div>
                            <div class="con">‚ùå Vereist Spotify account (gratis)</div>
                        </div>
                    </div>

                    <div class="storage-option" onclick="chooseStorage('local')">
                        <h3>üíæ Lokaal</h3>
                        <div class="pros-cons">
                            <div class="pro">‚úÖ Geen account nodig</div>
                            <div class="pro">‚úÖ Werkt offline</div>
                            <div class="con">‚ùå Alleen op dit apparaat + browser</div>
                            <div class="con">‚ùå Niet priv√© bij gedeeld apparaat</div>
                            <div class="con">‚ùå Verdwijnt bij cache wissen</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main App (hidden until storage is chosen) -->
            <div id="mainApp" style="display: none;">
                <!-- Spotify Connection Status -->
                <div id="spotifyStatus" style="display: none;" class="spotify-status">
                    <div class="status-indicator">
                        <span class="status-dot"></span>
                        <span id="statusText">Niet verbonden</span>
                    </div>
                    <button id="logoutBtn" class="btn btn-danger btn-small" style="display: none;">
                        Uitloggen
                    </button>
                </div>

                <!-- Now Playing Section -->
                <div class="now-playing">
                    <div id="nowPlayingContent" class="loading">
                        Bezig met laden...
                    </div>
                </div>

                <!-- Add to List Button -->
                <button id="addToListBtn" class="btn btn-primary btn-block" disabled>
                    <span id="addBtnText">Voeg toe aan mijn stemlijst</span>
                </button>

                <button id="changeStorageBtn" class="btn btn-secondary btn-block">
                    Wijzig opslagmethode
                </button>
            </div>
        </div>

        <!-- Saved Tracks List -->
        <div id="savedTracksCard" class="card" style="display: none;">
            <h2>Mijn Stemlijst</h2>
            <div class="track-count" id="trackCount">0 nummers</div>
            <div id="savedTracksList"></div>
        </div>

        <!-- Spotify Configuration (only for Spotify users) -->
        <div id="spotifyConfig" class="card" style="display: none;">
            <h2>‚öôÔ∏è Spotify Configuratie</h2>
            <p style="margin-bottom: 16px; font-size: 14px; color: #B3B3B3;">
                <strong>Let op:</strong> Je hebt een Spotify Developer App nodig. Volg deze stappen:
            </p>
            <ol style="margin-left: 20px; margin-bottom: 16px; font-size: 14px; color: #B3B3B3; line-height: 1.6;">
                <li>Ga naar <a href="https://developer.spotify.com/dashboard" target="_blank" style="color: #1DB954; text-decoration: none; font-weight: 700;">Spotify Developer Dashboard</a></li>
                <li>Maak een nieuwe app aan</li>
                <li>Kopieer de <strong style="color: #FFFFFF;">Client ID</strong></li>
                <li>Voeg deze <strong style="color: #FFFFFF;">Redirect URI</strong> toe: <code id="redirectUriDisplay"></code></li>
                <li>Vul hieronder je Client ID in</li>
            </ol>
            <div class="config-section">
                <label for="spotifyClientId"><strong>Spotify Client ID:</strong></label>
                <input
                    type="text"
                    id="spotifyClientId"
                    placeholder="Plak hier je Spotify Client ID"
                    value=""
                />
                <button id="saveConfigBtn" class="btn btn-success btn-block" style="margin-top: 12px;">
                    Opslaan en verbinden met Spotify
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const NPO_API_URL = 'https://www.nporadio2.nl/api/miniplayer/info?channel=npo-radio-2';
        const SPOTIFY_AUTH_URL = 'https://accounts.spotify.com/authorize';
        const SPOTIFY_TOKEN_URL = 'https://accounts.spotify.com/api/token';
        const SPOTIFY_API_URL = 'https://api.spotify.com/v1';
        const POLL_INTERVAL = 15000; // 15 seconds
        const SPOTIFY_SCOPES = 'playlist-modify-public playlist-modify-private playlist-read-private user-library-read';

        // Get redirect URI dynamically
        const REDIRECT_URI = window.location.origin + window.location.pathname;

        // ============================================
        // STATE
        // ============================================
        let currentTrack = null;
        let storageMethod = null;
        let spotifyAccessToken = null;
        let spotifyRefreshToken = null;
        let spotifyTokenExpiry = null;
        let pollTimer = null;
        let isAddingTrack = false;

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.textContent = message;
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }

        function saveToLocalStorage(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
        }

        function getFromLocalStorage(key) {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : null;
        }

        function updateTrackCount() {
            const tracks = getFromLocalStorage('top2000lijst') || [];
            const countEl = document.getElementById('trackCount');
            const count = tracks.length;
            countEl.textContent = `${count} ${count === 1 ? 'nummer' : 'nummers'}`;
        }

        // ============================================
        // SPOTIFY PKCE FUNCTIONS
        // ============================================
        function generateRandomString(length) {
            const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            const values = crypto.getRandomValues(new Uint8Array(length));
            return values.reduce((acc, x) => acc + possible[x % possible.length], '');
        }

        async function sha256(plain) {
            const encoder = new TextEncoder();
            const data = encoder.encode(plain);
            return window.crypto.subtle.digest('SHA-256', data);
        }

        function base64urlencode(a) {
            return btoa(String.fromCharCode.apply(null, new Uint8Array(a)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function generateCodeChallenge(codeVerifier) {
            const hashed = await sha256(codeVerifier);
            return base64urlencode(hashed);
        }

        // ============================================
        // SPOTIFY AUTHENTICATION
        // ============================================
        async function initiateSpotifyLogin() {
            const clientId = getFromLocalStorage('spotifyClientId');

            if (!clientId) {
                showAlert('Vul eerst je Spotify Client ID in bij Configuratie hieronder', 'warning');
                document.getElementById('spotifyConfig').style.display = 'block';
                return;
            }

            const codeVerifier = generateRandomString(64);
            const codeChallenge = await generateCodeChallenge(codeVerifier);

            // Store code verifier for later use
            saveToLocalStorage('spotifyCodeVerifier', codeVerifier);

            const params = new URLSearchParams({
                client_id: clientId,
                response_type: 'code',
                redirect_uri: REDIRECT_URI,
                scope: SPOTIFY_SCOPES,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });

            window.location.href = `${SPOTIFY_AUTH_URL}?${params.toString()}`;
        }

        async function handleSpotifyCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const error = params.get('error');

            if (error) {
                showAlert(`Spotify authenticatie mislukt: ${error}`, 'error');
                return;
            }

            if (code) {
                const codeVerifier = getFromLocalStorage('spotifyCodeVerifier');
                const clientId = getFromLocalStorage('spotifyClientId');

                if (!codeVerifier || !clientId) {
                    showAlert('Authenticatie fout: verifier of client ID ontbreekt', 'error');
                    return;
                }

                try {
                    const response = await fetch(SPOTIFY_TOKEN_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            client_id: clientId,
                            grant_type: 'authorization_code',
                            code: code,
                            redirect_uri: REDIRECT_URI,
                            code_verifier: codeVerifier
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Token exchange failed');
                    }

                    const data = await response.json();

                    // Store tokens
                    spotifyAccessToken = data.access_token;
                    spotifyRefreshToken = data.refresh_token;
                    spotifyTokenExpiry = Date.now() + (data.expires_in * 1000);

                    saveToLocalStorage('spotifyAccessToken', spotifyAccessToken);
                    saveToLocalStorage('spotifyRefreshToken', spotifyRefreshToken);
                    saveToLocalStorage('spotifyTokenExpiry', spotifyTokenExpiry);

                    // Clean up URL and code verifier
                    localStorage.removeItem('spotifyCodeVerifier');
                    window.history.replaceState({}, document.title, window.location.pathname);

                    showAlert('Succesvol verbonden met Spotify! üéâ', 'success');
                    updateSpotifyStatus();

                } catch (error) {
                    console.error('Token exchange error:', error);
                    showAlert('Fout bij verbinden met Spotify. Probeer opnieuw.', 'error');
                }
            }
        }

        async function refreshSpotifyToken() {
            const clientId = getFromLocalStorage('spotifyClientId');
            const refreshToken = getFromLocalStorage('spotifyRefreshToken');

            if (!refreshToken || !clientId) {
                return false;
            }

            try {
                const response = await fetch(SPOTIFY_TOKEN_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        client_id: clientId,
                        grant_type: 'refresh_token',
                        refresh_token: refreshToken
                    })
                });

                if (!response.ok) {
                    throw new Error('Token refresh failed');
                }

                const data = await response.json();

                spotifyAccessToken = data.access_token;
                spotifyTokenExpiry = Date.now() + (data.expires_in * 1000);

                // Update refresh token if provided
                if (data.refresh_token) {
                    spotifyRefreshToken = data.refresh_token;
                    saveToLocalStorage('spotifyRefreshToken', spotifyRefreshToken);
                }

                saveToLocalStorage('spotifyAccessToken', spotifyAccessToken);
                saveToLocalStorage('spotifyTokenExpiry', spotifyTokenExpiry);

                return true;
            } catch (error) {
                console.error('Token refresh error:', error);
                return false;
            }
        }

        async function ensureValidToken() {
            // Check if token exists
            if (!spotifyAccessToken) {
                return false;
            }

            // Check if token is expired or about to expire (5 minute buffer)
            if (spotifyTokenExpiry && (Date.now() + 300000) >= spotifyTokenExpiry) {
                return await refreshSpotifyToken();
            }

            return true;
        }

        function updateSpotifyStatus() {
            const statusDiv = document.getElementById('spotifyStatus');
            const statusText = document.getElementById('statusText');
            const statusDot = statusDiv.querySelector('.status-dot');
            const logoutBtn = document.getElementById('logoutBtn');

            if (storageMethod === 'spotify') {
                statusDiv.style.display = 'flex';

                if (spotifyAccessToken) {
                    statusDiv.classList.add('connected');
                    statusDot.classList.add('connected');
                    statusText.textContent = 'Verbonden met Spotify';
                    logoutBtn.style.display = 'block';
                } else {
                    statusDiv.classList.remove('connected');
                    statusDot.classList.remove('connected');
                    statusText.textContent = 'Niet verbonden - klik hieronder om in te loggen';
                    logoutBtn.style.display = 'none';
                }
            } else {
                statusDiv.style.display = 'none';
            }
        }

        function logoutSpotify() {
            if (confirm('Weet je zeker dat je wilt uitloggen van Spotify?')) {
                spotifyAccessToken = null;
                spotifyRefreshToken = null;
                spotifyTokenExpiry = null;

                localStorage.removeItem('spotifyAccessToken');
                localStorage.removeItem('spotifyRefreshToken');
                localStorage.removeItem('spotifyTokenExpiry');

                updateSpotifyStatus();
                showAlert('Uitgelogd van Spotify', 'info');
            }
        }

        // ============================================
        // NPO RADIO 2 API
        // ============================================
        async function fetchNowPlaying() {
            try {
                const response = await fetch(NPO_API_URL);

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();

                // Parse the response - miniplayer API format
                let artist, title;

                // Get current playing track from radioTrackPlays
                const currentPlay = data?.data?.radioTrackPlays?.data?.[0];

                if (currentPlay?.artist && currentPlay?.song) {
                    artist = currentPlay.artist;
                    title = currentPlay.song;
                }

                if (artist && title) {
                    currentTrack = {
                        artist: artist,
                        title: title,
                        timestamp: new Date().toISOString()
                    };

                    displayNowPlaying(currentTrack);
                    document.getElementById('addToListBtn').disabled = false;
                } else {
                    throw new Error('Invalid data format');
                }

            } catch (error) {
                console.error('Error fetching now playing:', error);
                document.getElementById('nowPlayingContent').innerHTML = `
                    <div class="loading">‚ö†Ô∏è Kon niet verbinden met NPO Radio 2 API</div>
                `;
                document.getElementById('addToListBtn').disabled = true;
            }
        }

        function displayNowPlaying(track) {
            const container = document.getElementById('nowPlayingContent');
            const now = new Date().toLocaleTimeString('nl-NL', { hour: '2-digit', minute: '2-digit' });

            container.innerHTML = `
                <div class="track-info">
                    <div class="artist">${escapeHtml(track.artist)}</div>
                    <div class="title">${escapeHtml(track.title)}</div>
                    <div class="last-updated">Bijgewerkt om ${now}</div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // SPOTIFY API
        // ============================================
        async function searchSpotifyTrack(artist, title) {
            const isValid = await ensureValidToken();

            if (!isValid) {
                throw new Error('No valid Spotify token');
            }

            const query = `artist:${artist} track:${title}`;
            const params = new URLSearchParams({
                q: query,
                type: 'track',
                limit: 1
            });

            const response = await fetch(`${SPOTIFY_API_URL}/search?${params.toString()}`, {
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Spotify search failed');
            }

            const data = await response.json();

            if (data.tracks && data.tracks.items && data.tracks.items.length > 0) {
                return data.tracks.items[0];
            }

            return null;
        }

        async function addToSpotifyLikedSongs(trackUri) {
            const isValid = await ensureValidToken();

            if (!isValid) {
                throw new Error('No valid Spotify token');
            }

            // Extract track ID from URI
            const trackId = trackUri.replace('spotify:track:', '');

            const response = await fetch(`${SPOTIFY_API_URL}/me/tracks`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${spotifyAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ids: [trackId]
                })
            });

            if (!response.ok) {
                throw new Error('Failed to add to liked songs');
            }

            return true;
        }

        // ============================================
        // TRACK MANAGEMENT
        // ============================================
        async function addTrackToList() {
            if (!currentTrack || isAddingTrack) {
                return;
            }

            isAddingTrack = true;
            const addBtn = document.getElementById('addToListBtn');
            const btnText = document.getElementById('addBtnText');
            const originalText = btnText.textContent;

            addBtn.disabled = true;
            btnText.innerHTML = '<span class="spinner"></span> Bezig met toevoegen...';

            try {
                // Check for duplicates in localStorage
                const localTracks = getFromLocalStorage('top2000lijst') || [];
                const isDuplicate = localTracks.some(t =>
                    t.artist.toLowerCase() === currentTrack.artist.toLowerCase() &&
                    t.title.toLowerCase() === currentTrack.title.toLowerCase()
                );

                if (isDuplicate) {
                    showAlert('Dit nummer staat al in je lijst!', 'warning');
                    return;
                }

                // Handle based on storage method
                if (storageMethod === 'spotify') {
                    if (!spotifyAccessToken) {
                        showAlert('Je bent niet verbonden met Spotify. Log eerst in!', 'warning');
                        await initiateSpotifyLogin();
                        return;
                    }

                    // Search for track on Spotify
                    const spotifyTrack = await searchSpotifyTrack(currentTrack.artist, currentTrack.title);

                    if (!spotifyTrack) {
                        showAlert('Nummer niet gevonden op Spotify. Toegevoegd aan lokale lijst.', 'warning');
                        // Fallback to local storage
                        currentTrack.spotifyUri = null;
                        localTracks.push(currentTrack);
                        saveToLocalStorage('top2000lijst', localTracks);
                    } else {
                        // Add to Spotify liked songs
                        await addToSpotifyLikedSongs(spotifyTrack.uri);

                        // Also save to local storage with Spotify URI
                        currentTrack.spotifyUri = spotifyTrack.uri;
                        localTracks.push(currentTrack);
                        saveToLocalStorage('top2000lijst', localTracks);

                        showAlert('‚úÖ Nummer toegevoegd aan je Spotify liked songs!', 'success');
                    }
                } else {
                    // Local storage only
                    localTracks.push(currentTrack);
                    saveToLocalStorage('top2000lijst', localTracks);
                    showAlert('‚úÖ Nummer toegevoegd aan je lokale lijst!', 'success');
                }

                renderTrackList();
                updateTrackCount();

            } catch (error) {
                console.error('Error adding track:', error);
                showAlert('‚ö†Ô∏è Fout bij toevoegen. Probeer opnieuw.', 'error');
            } finally {
                isAddingTrack = false;
                addBtn.disabled = false;
                btnText.textContent = originalText;
            }
        }

        function removeTrack(index) {
            if (confirm('Weet je zeker dat je dit nummer wilt verwijderen?')) {
                const tracks = getFromLocalStorage('top2000lijst') || [];
                tracks.splice(index, 1);
                saveToLocalStorage('top2000lijst', tracks);
                renderTrackList();
                updateTrackCount();
                showAlert('Nummer verwijderd', 'info');
            }
        }

        function renderTrackList() {
            const tracks = getFromLocalStorage('top2000lijst') || [];
            const container = document.getElementById('savedTracksList');
            const card = document.getElementById('savedTracksCard');

            if (tracks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéµ</div>
                        <p>Nog geen nummers toegevoegd</p>
                        <p style="font-size: 14px; margin-top: 8px;">Voeg nummers toe terwijl je luistert!</p>
                    </div>
                `;
                card.style.display = 'block';
                return;
            }

            card.style.display = 'block';

            const html = tracks.map((track, index) => `
                <div class="track-item">
                    <div class="track-details">
                        <div class="track-artist">${escapeHtml(track.artist)}</div>
                        <div class="track-title">${escapeHtml(track.title)}</div>
                    </div>
                    <button class="btn btn-danger btn-small" onclick="removeTrack(${index})">
                        Verwijder
                    </button>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // ============================================
        // STORAGE CHOICE
        // ============================================
        function chooseStorage(method) {
            storageMethod = method;
            saveToLocalStorage('storageMethod', method);

            document.getElementById('storageChoice').classList.remove('active');
            document.getElementById('mainApp').style.display = 'block';

            if (method === 'spotify') {
                document.getElementById('spotifyConfig').style.display = 'block';
                updateSpotifyStatus();
            } else {
                document.getElementById('spotifyConfig').style.display = 'none';
                showAlert('Lokale opslag actief. Let op: lijst is alleen zichtbaar op dit apparaat.', 'info');
            }

            // Start fetching now playing
            fetchNowPlaying();
            startPolling();
            renderTrackList();
            updateTrackCount();
        }

        function changeStorage() {
            if (confirm('Weet je zeker dat je de opslagmethode wilt wijzigen? Je huidige lijst blijft bewaard.')) {
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('storageChoice').classList.add('active');
                stopPolling();
            }
        }

        // ============================================
        // POLLING
        // ============================================
        function startPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
            }
            pollTimer = setInterval(fetchNowPlaying, POLL_INTERVAL);
        }

        function stopPolling() {
            if (pollTimer) {
                clearInterval(pollTimer);
                pollTimer = null;
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        function init() {
            // Display redirect URI for user
            document.getElementById('redirectUriDisplay').textContent = REDIRECT_URI;

            // Load saved data
            storageMethod = getFromLocalStorage('storageMethod');
            spotifyAccessToken = getFromLocalStorage('spotifyAccessToken');
            spotifyRefreshToken = getFromLocalStorage('spotifyRefreshToken');
            spotifyTokenExpiry = getFromLocalStorage('spotifyTokenExpiry');

            // Load saved Spotify Client ID
            const savedClientId = getFromLocalStorage('spotifyClientId');
            if (savedClientId) {
                document.getElementById('spotifyClientId').value = savedClientId;
            }

            // Check for OAuth callback
            if (window.location.search.includes('code=')) {
                handleSpotifyCallback();
            }

            // Show appropriate screen
            if (storageMethod) {
                document.getElementById('mainApp').style.display = 'block';

                if (storageMethod === 'spotify') {
                    document.getElementById('spotifyConfig').style.display = 'block';
                    updateSpotifyStatus();
                }

                fetchNowPlaying();
                startPolling();
                renderTrackList();
                updateTrackCount();
            } else {
                document.getElementById('storageChoice').classList.add('active');
            }

            // Event listeners
            document.getElementById('addToListBtn').addEventListener('click', addTrackToList);
            document.getElementById('changeStorageBtn').addEventListener('click', changeStorage);
            document.getElementById('logoutBtn').addEventListener('click', logoutSpotify);
            document.getElementById('saveConfigBtn').addEventListener('click', () => {
                const clientId = document.getElementById('spotifyClientId').value.trim();

                if (!clientId) {
                    showAlert('Vul een Client ID in', 'warning');
                    return;
                }

                saveToLocalStorage('spotifyClientId', clientId);
                showAlert('Client ID opgeslagen! Je kunt nu verbinden met Spotify.', 'success');

                // Initiate login
                initiateSpotifyLogin();
            });

            // Make removeTrack global
            window.removeTrack = removeTrack;
        }

        // Start the app
        init();
    </script>
</body>
</html>
